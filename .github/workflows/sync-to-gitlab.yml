name: Sync to GitLab

on:
  push:
    branches:
      - master
      - main
      - '*'  # Sync all branches
  delete:
    branches:
      - '*'  # Sync branch deletions
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Verify secrets are configured
        run: |
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "ERROR: GITLAB_TOKEN secret is not configured!"
            echo "Please add GITLAB_TOKEN secret in GitHub repository settings."
            exit 1
          fi
          if [ -z "${{ secrets.GITLAB_REPO }}" ]; then
            echo "ERROR: GITLAB_REPO secret is not configured!"
            echo "Please add GITLAB_REPO secret in GitHub repository settings."
            exit 1
          fi
          echo "✅ Secrets are configured"
          echo "GitLab repository: ${{ secrets.GITLAB_REPO }}"

          # Check token format
          TOKEN_PREFIX=$(echo "${{ secrets.GITLAB_TOKEN }}" | cut -c1-6)
          echo "Token prefix: ${TOKEN_PREFIX}"
          if [[ "$TOKEN_PREFIX" == "glpat-" ]]; then
            echo "✅ Token format looks correct (Personal Access Token)"
          elif [[ "$TOKEN_PREFIX" == "gldt-" ]]; then
            echo "✅ Token format looks correct (Deploy Token)"
          else
            echo "⚠️ Warning: Token doesn't start with glpat- or gldt-. This might be an old token format."
          fi

      - name: Test GitLab API access and create repo if needed
        run: |
          echo "=========================================="
          echo "DETAILED DIAGNOSTICS"
          echo "=========================================="

          # Check token format and length
          TOKEN_LENGTH=$(echo -n "${{ secrets.GITLAB_TOKEN }}" | wc -c)
          TOKEN_PREFIX=$(echo "${{ secrets.GITLAB_TOKEN }}" | cut -c1-7)
          echo "Token length: $TOKEN_LENGTH characters"
          echo "Token starts with: ${TOKEN_PREFIX}..."

          # Check GITLAB_REPO format
          echo "GITLAB_REPO value: '${{ secrets.GITLAB_REPO }}'"
          REPO_LENGTH=$(echo -n "${{ secrets.GITLAB_REPO }}" | wc -c)
          echo "GITLAB_REPO length: $REPO_LENGTH characters"

          # Check for spaces or special characters
          if [[ "${{ secrets.GITLAB_REPO }}" =~ [[:space:]] ]]; then
            echo "⚠️ WARNING: GITLAB_REPO contains spaces!"
          fi

          if [[ "${{ secrets.GITLAB_REPO }}" == http* ]]; then
            echo "❌ ERROR: GITLAB_REPO should not contain URL (http/https)"
            echo "Format should be: username/repo-name"
            exit 1
          fi

          # Test 1: Check if token can authenticate at all
          echo ""
          echo "=========================================="
          echo "TEST 1: Testing token authentication..."
          echo "=========================================="

          USER_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --header "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            "https://gitlab.com/api/v4/user")

          USER_HTTP_CODE=$(echo "$USER_RESPONSE" | tail -n1)
          USER_BODY=$(echo "$USER_RESPONSE" | head -n-1)

          echo "Response Code: $USER_HTTP_CODE"

          if [ "$USER_HTTP_CODE" = "200" ]; then
            echo "✅ Token is VALID and can authenticate!"
            USERNAME=$(echo "$USER_BODY" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)
            echo "Authenticated as: $USERNAME"
          else
            echo "❌ Token CANNOT authenticate (401)"
            echo "This means the token itself is invalid or expired."
            echo "Response body:"
            echo "$USER_BODY"
            echo ""
            echo "ACTION REQUIRED:"
            echo "1. Go to https://gitlab.com/-/profile/personal_access_tokens"
            echo "2. Check if your token is still active (not expired/revoked)"
            echo "3. Create a NEW token with scopes: api, read_repository, write_repository"
            echo "4. Copy the ENTIRE token (usually 20-26 characters)"
            echo "5. Update GITLAB_TOKEN in GitHub: Settings → Secrets → Actions"
            exit 1
          fi

          # Test 2: Check repository access
          echo ""
          echo "=========================================="
          echo "TEST 2: Testing repository access..."
          echo "=========================================="

          # URL encode the repository path
          ENCODED_REPO=$(echo "${{ secrets.GITLAB_REPO }}" | sed 's/\//%2F/g')
          echo "Encoded repo path: $ENCODED_REPO"

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --header "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            "https://gitlab.com/api/v4/projects/${ENCODED_REPO}")

          echo "API Response Code: $RESPONSE"

          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Repository exists and is accessible"
          elif [ "$RESPONSE" = "401" ]; then
            echo "❌ ERROR: Token authentication failed (401 Unauthorized)"
            echo "Possible issues:"
            echo "  - Token is invalid or expired"
            echo "  - Token doesn't have 'api' or 'read_api' scope"
            exit 1
          elif [ "$RESPONSE" = "404" ]; then
            echo "❌ ERROR: Repository not found or no access (404)"
            echo "Repository path: ${{ secrets.GITLAB_REPO }}"
            echo ""
            echo "This could mean:"
            echo "  1. Repository doesn't exist on GitLab"
            echo "  2. Repository is private and token doesn't have 'api' scope"
            echo "  3. Token doesn't have access to this repository"
            echo ""
            echo "If repository exists and is PRIVATE:"
            echo "  → Your token MUST have 'api' scope to access private repos"
            echo "  → Go to GitLab → Settings → Access Tokens"
            echo "  → Create new token with scopes: api, write_repository, read_repository"
            echo "  → Update GITLAB_TOKEN secret in GitHub"
            echo ""
            echo "If repository doesn't exist, attempting to create it..."

            # Extract username and repo name
            IFS='/' read -r NAMESPACE REPO_NAME <<< "${{ secrets.GITLAB_REPO }}"

            # Create repository
            CREATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
              --header "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "{
                \"name\": \"${REPO_NAME}\",
                \"path\": \"${REPO_NAME}\",
                \"visibility\": \"private\",
                \"initialize_with_readme\": false
              }" \
              "https://gitlab.com/api/v4/projects")

            HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$CREATE_RESPONSE" | head -n-1)

            if [ "$HTTP_CODE" = "201" ]; then
              echo "✅ Successfully created repository on GitLab!"
              echo "Repository URL: https://gitlab.com/${{ secrets.GITLAB_REPO }}"
            elif [ "$HTTP_CODE" = "401" ]; then
              echo "❌ Token doesn't have permission to create repositories"
              echo "Token needs 'api' scope to create projects"
              exit 1
            else
              echo "❌ Failed to create repository (likely it already exists but token can't access it)"
              echo "HTTP Code: $HTTP_CODE"
              echo ""
              echo "ACTION REQUIRED:"
              echo "Your GitLab token needs 'api' scope to access private repositories!"
              echo ""
              echo "Steps to fix:"
              echo "1. Go to https://gitlab.com/-/profile/personal_access_tokens"
              echo "2. Create a new token with these scopes:"
              echo "   - api ✓"
              echo "   - write_repository ✓"
              echo "   - read_repository ✓"
              echo "3. Copy the token"
              echo "4. Update GITLAB_TOKEN secret in GitHub repository settings"
              exit 1
            fi
          else
            echo "⚠️ Unexpected response code: $RESPONSE"
            echo "Continuing anyway..."
          fi

      - name: Add GitLab remote and push
        run: |
          # Use token directly in URL for better compatibility
          GITLAB_URL="https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/${{ secrets.GITLAB_REPO }}.git"

          # Add GitLab remote
          git remote add gitlab "$GITLAB_URL" 2>/dev/null || git remote set-url gitlab "$GITLAB_URL"

          echo "Remote configured:"
          git remote -v | grep gitlab | sed 's/oauth2:.*@/oauth2:***@/g'

          # Test connection with a simple fetch
          echo "Testing connection to GitLab..."
          if git ls-remote gitlab HEAD > /dev/null 2>&1; then
            echo "✅ Successfully connected to GitLab repository"
          else
            echo "❌ Failed to connect to GitLab repository"
            echo "This usually means:"
            echo "  - Token doesn't have 'write_repository' scope"
            echo "  - Repository doesn't exist"
            echo "  - Token doesn't have access to the repository"
            exit 1
          fi

          # Push all branches
          echo "Pushing all branches to GitLab..."
          git push gitlab --all --force
          echo "✅ Branches pushed successfully"

          # Push all tags
          echo "Pushing all tags to GitLab..."
          git push gitlab --tags --force || echo "No tags to push"
          echo "✅ Tags pushed successfully"

          echo "✅ Successfully synced to GitLab"
        env:
          GIT_TERMINAL_PROMPT: 0

  sync-on-delete:
    runs-on: ubuntu-latest
    if: github.event_name == 'delete'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add GitLab remote and delete branch
        run: |
          # Configure Git credentials
          git config --global credential.helper store
          echo "https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com" > ~/.git-credentials

          # Add GitLab remote
          git remote add gitlab https://gitlab.com/${{ secrets.GITLAB_REPO }}.git || git remote set-url gitlab https://gitlab.com/${{ secrets.GITLAB_REPO }}.git

          # Delete branch on GitLab
          git push gitlab --delete ${{ github.event.ref }} || echo "Branch already deleted or doesn't exist on GitLab"
        env:
          GIT_TERMINAL_PROMPT: 0
